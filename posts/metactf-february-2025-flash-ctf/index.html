<!doctype html><html lang=en dir=auto data-theme=dark><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>MetaCTF February 2025 Flash CTF | He\xED.SPACE</title><meta name=keywords content="ctf"><meta name=description content="MetaCTF February 2025 Flash CTF challenges from https://metactf.com"><meta name=author content="Yordan D."><link rel=canonical href=https://hexed.space/posts/metactf-february-2025-flash-ctf/><link crossorigin=anonymous href=/assets/css/stylesheet.56c50aa37d9a91635d162d93a94c5f0ba752d10c5e73ec9edd18f12c3d02255b.css integrity="sha256-VsUKo32akWNdFi2TqUxfC6dS0Qxec+ye3RjxLD0CJVs=" rel="preload stylesheet" as=style><link rel=icon href=https://hexed.space/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://hexed.space/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://hexed.space/favicon-32x32.png><link rel=apple-touch-icon href=https://hexed.space/apple-touch-icon.png><link rel=mask-icon href=https://hexed.space/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://hexed.space/posts/metactf-february-2025-flash-ctf/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><script>localStorage.getItem("pref-theme")==="light"&&(document.querySelector("html").dataset.theme="light")</script><meta property="og:url" content="https://hexed.space/posts/metactf-february-2025-flash-ctf/"><meta property="og:site_name" content="He\xED.SPACE"><meta property="og:title" content="MetaCTF February 2025 Flash CTF"><meta property="og:description" content="MetaCTF February 2025 Flash CTF challenges from https://metactf.com"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-02-28T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-28T00:00:00+00:00"><meta property="article:tag" content="Ctf"><meta name=twitter:card content="summary"><meta name=twitter:title content="MetaCTF February 2025 Flash CTF"><meta name=twitter:description content="MetaCTF February 2025 Flash CTF challenges from https://metactf.com"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://hexed.space/posts/"},{"@type":"ListItem","position":2,"name":"MetaCTF February 2025 Flash CTF","item":"https://hexed.space/posts/metactf-february-2025-flash-ctf/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"MetaCTF February 2025 Flash CTF","name":"MetaCTF February 2025 Flash CTF","description":"MetaCTF February 2025 Flash CTF challenges from https://metactf.com","keywords":["ctf"],"articleBody":"MetaCTF February 2025 Flash CTF consists of 5 challenges.\nCookie Crackdown We’re auditing some websites to check if they’re GDPR compliant, and I’m pretty sure this site isn’t…\nUpon loading the site, we are presented with a modal requiring us to consent to cookies.\nFrom the challenge description and the web page, we can assume that the flag is probably stored as a cookie.\nPressing F12 will bring up the Developer menu. Navigating to the Application tab and then selecting Cookies will reveal a cookie conveniently named flag.\nbetter_eval() I just want to let people run python code, but they keep trying to read flag.txt. So, I made a better eval that has filters to stop this!\nDownload the code here and connect to the remote instance with nc [REDACTED] 30019\nIn the event that remote instance goes down, you can also use nc [REDACTED] 5110. These two are identical, this is just the backup.\nHere’s the Python code\n#!/usr/local/bin/python def better_eval(untrusted_code): blocked_terms = [\"flag\", \"+\", \"import\", \"os\", \"eval\", \"exec\"] for term in blocked_terms: if term in untrusted_code: print(f\"The term {term} is filtered!\") return try: # Execute the user input in the restricted environment without globals or locals print(eval(untrusted_code)) except Exception as e: print(f\"Error: {e}\") while True: untrusted_code = input(\"Enter your python code\u003e \") better_eval(untrusted_code) We can see that there is a list of blocked keywords, including import, os, and flag.\nAlthough this appears to impose strict limitations, we can bypass the filter with a simple one-liner using obfuscation:\nprint(open(\"txt.galf\"[::-1]).read().strip()) This command opens and prints the content of the flag.txt file. To evade the filter, we spell “flag.txt” backwards and then reverse it in Python to access the correct filename.\nExploiting the filter\n└─$ nc [REDACTED] 30019 Enter your python code\u003e print(open(\"txt.galf\"[::-1]).read().strip()) MetaCTF{f1l73rs_d0_n0t_s3cur3_u} None Enter your python code\u003e By reversing the string flag.txt, we successfully bypassed the keyword filter and retrieved the flag. This demonstrates that simple blacklisting of keywords is not a reliable security measure, as it can often be circumvented with obfuscation techniques.\nTill Delete Do Us Part I was messing with trying to dual boot, and while trying to fix partitions, I accidentally deleted the one on my wedding flash drive I carelessly had plugged in! Please help me recover it!\nOnce we download the file, we need to identify its type with file command:\n└─$ file usb.img usb.img: DOS/MBR boot sector This indicates that the file is a disk image containing a DOS/MBR boot sector. It could represent a USB drive, hard drive, or partition.\nWe use fdisk or parted to inspect the partitions:\n└─$ fdisk -l usb.img Disk usb.img: 256 MiB, 268435456 bytes, 524288 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xf4fa0c7e └─$ parted usb.img WARNING: You are not superuser. Watch out for permissions. GNU Parted 3.6 Using /home/kali/metactf_ctf 2025 feb/usbnew/usb.img Welcome to GNU Parted! Type 'help' to view a list of commands. (parted) print Model: (file) Disk /home/kali/metactf_ctf 2025 feb/usbnew/usb.img: 268MB Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags No partitions are found. Since they might have been deleted, we attempt to recover them.\nWe use testdisk to restore the lost partition:\ntestdisk usb.img Select Proceed Choose Intel for the partition table Select Analyse -\u003e Quick Search Locate the FAT32 partition and select Write Confirm with Y and press Enter If we check again with fdisk or parted, the partitions should be restored:\n└─$ fdisk -l usb.img Disk usb.img: 256 MiB, 268435456 bytes, 524288 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0xf4fa0c7e Device Boot Start End Sectors Size Id Type usb.img1 * 2048 524287 522240 255M b W95 FAT32 ─$ parted usb.img (parted) print Model: (file) Disk /home/kali/metactf_ctf 2025 feb/usbnew/usb.img: 268MB Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 1 1049kB 268MB 267MB primary fat32 boot Next, we will need to mount the drive. To mount a disk image containing partitions, we must specify the offset so the system knows where the partition starts. The offset is calculated as:\nOffset = Starting Sector × Sector Size Offset = 2048 × 512 = 1048576 For most disks the sector size is 512.\nWe can mount the partition:\nsudo mount -o loop,offset=1048576 usb.img /mnt/usb Once mounted, we can explore the drive. Let’s check the Wedding photos directory for any hidden messages:\nstrings *.jpg | grep -i Meta Nothing comes up.\nWe can use also SleuthKit and fls to list all files, including deleted ones:\nfls -r -o 2048 usb.img Nowe we have a list of all the files and directories, including the ones marked as deleted.\nd/d 62691: .Meta + d/d 62677: CTF ++ d/d 62710: {n +++ d/d 62725: 0 ++++ d/d 62742: t +++++ d/d 62757: _ ++++++ d/d 62774: ev +++++++ d/d 62790: 3n ++++++++ d/d 62805: _ +++++++++ d/d 62822: d3 ++++++++++ d/d 62838: l3t +++++++++++ d/d 62854: 10n ++++++++++++ d/d 62869: _ +++++++++++++ d/d 62886: c4 ++++++++++++++ d/d 62902: n +++++++++++++++ d/d 62917: _ ++++++++++++++++ d/d 62934: s3 +++++++++++++++++ d/d 62950: part ++++++++++++++++++ d/d 62965: 3_ +++++++++++++++++++ d/d 62982: u ++++++++++++++++++++ d/d 62997: 5} The flag is made of nested directories. Extract the directories’ names to reconstruct it.\nFiles marked for deletion can be recovered with icat and the sector offset:\nicat -o 2048 usb.img 63014 \u003e clue.txt This extracts clue.txt from sector 63014.\nCarrot Our threat intelligence has found a malware sample that seems heavily targeted at our competitor, MeatCTF. We tried to analyze it, but it just does nothing when we run it in a VM, can you help us analyze this?\nDownload the sample here and unzip with the password infected\nExtract the file and run file:\n└─$ file carrot carrot: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fd82f7845645aea67dee789f5cac0de456e83108, for GNU/Linux 4.4.0, stripped This is a 64-bit Linux ELF binary, dynamically linked and PIE-enabled, keep that in mind for later.\nLoad it into IDA for static analysis. Press F5 to generate pseudocode.\nScrolling through the functions, we find .PEM_read_bio_RSA_PUBKEY, indicating that encryption is likely occurring somewhere in the code.\nOpen the main function and its pseudocode.\nWe can see there’s a block of if statements that lead to more code execution. To reach that point in the code, we will need to pass the validation checks presented by the aforementioned if block.\nif ( !(unsigned int)sub_3531(a1, a2, a3) \u0026\u0026 !(unsigned int)sub_371A() \u0026\u0026 !(unsigned int)sub_3773() \u0026\u0026 !(unsigned int)sub_356F() \u0026\u0026 !(unsigned int)sub_3622() \u0026\u0026 (unsigned int)sub_37DA() \u0026\u0026 (unsigned int)sub_32B6() \u0026\u0026 !(unsigned int)sub_3378() \u0026\u0026 (unsigned int)sub_3503() \u0026\u0026 !(unsigned int)sub_2C87() \u0026\u0026 (int)sub_2C5A() \u003e 1 ) { There are quite a few, so let’s go through them.\nsub_3531() This function appears to check if ptrace is running. Since we do not use ptrace, we can ignore this one.\nsub_371A() _BOOL8 sub_371A() { time_t v0; // rax _BOOL8 result; // rax time_t v2; // rbx time_t v3; // rdi double v4; // xmm0_8 v0 = time(0LL); if ( v0 == -1 ) return 0LL; v2 = v0; sleep(0x96u); v3 = time(0LL); if ( v3 == -1 ) return 0LL; v4 = difftime(v3, v2); result = 1LL; if ( v4 \u003e= 149.95 ) return v4 \u003e 150.25; return result; } This is an anti-debugging function. It gets the system time, sleeps for 150 seconds, then gets the system time again after sleep. If the difference between the two times is about 150 seconds, it returns true, allowing the check to pass. If the difference is not close to 150 seconds, it returns false, and the check fails.\nThere are numerous ways to bypass this, but the easiest approach is to change the value of the sleep timer to 1 second (0x1 in hex).\nRight click on the instruction, select Manual, and change 96h to 1h\nAddress Original Patch 372C mov edi, 96h mov edi, 1h Next, go to the main function, select the following instruction, then go to Edit -\u003e Patch Program -\u003e Change Byte:\nAddress Instruction 248C jnz short loc_2477 Replace the opcode for jnz (75) with jz (74) to reverse the if-statement:\n74 E9 E8 E0 12 00 00 85 C0 75 E0 E8 D3 10 00 00 Address Original Patched 248C jnz short loc_2477 jz short loc_2477 sub_3773() Another function that involves timers.\nThe loop continues until the difference (difftime(v2, v0)) is at least 150.0 seconds.\nOnce the loop exits, it calculates the final difference (v3 = difftime(v2, v0)) and sets result to 1 (TRUE).\nAt the end, it checks if v3 is greater than or equal to 149.95. If so, it returns whether v3 is greater than 150.25.\n0 (false) 1 (true) If time(0LL) fails (returns -1). If v3 \u003e= 149.95 and v3 \u003e 150.25. If v3 \u003e= 149.95 but v3 \u003c= 150.25. If v3 \u003c 149.95. do v2 = time(0LL); while ( difftime(v2, v0) \u003c 150.0 ); v3 = difftime(v2, v0); result = 1LL; if ( v3 \u003e= 149.95 ) return v3 \u003e 150.25; The validation check only passes if the function returns FALSE. Let’s patch it and reverse the process.\nThe opcode for ja is 77.\nThe opcode for jb is 72.\nAddress Original Patch 37A9 ja short loc_3788 jb short loc_3788 Address Original Patch 37C7 ja short loc_37D6 jb short loc_37D6 Go back to main().\nAddress Original Patch 2495 jnz short loc_2477 jz short loc_2477 sub_356F() This checks ensures the code is not running in a VM. Specifically, it opens /proc/cpuinfo and checks whether or not “hypervisor” is present.\nReverse it by patching jnz to jz in main(). Opcodes were provided earlier in the write-up.\nAddress Original Patch 249E jnz short loc_35BB jz short loc_35BB sub_3622() Another anti-VM check. This one looks for the strings QEMU, VirtualBox, and VMware. Just patch it in main().\nAddress Original Patch 24A7 jnz short loc_2477 jz short loc_2477 sub_37DA() This function uses curl to open two addresses: https://metactf.com and https://e205e724dda896b5a70bb03b7aed1dba.metactf.com. If the first address returns HTTP status code 200, v0 is set to TRUE. After this, curl tries to open the second address, and if the HTTP code is NOT 200, v0 is set to TRUE, and the function returns v0. For this validation to pass, the first URL needs to be accessible, and the second URL must not be. If we do a DNS check, we will find out that the second (sub)domain has no DNS records, so we don’t need to do anything here.\nsub_32B6() This function validates the IP address of the machine. It checks if the machine’s IP address starts with 10.13.37.. To bypass this, we will patch it in main().\n__int64 sub_32B6() { struct ifaddrs *i; // rbx const struct sockaddr *ifa_addr; // rdi struct ifaddrs *ifap; // [rsp+8h] [rbp-430h] BYREF char host[1025]; // [rsp+17h] [rbp-421h] BYREF unsigned __int64 v5; // [rsp+418h] [rbp-20h] v5 = __readfsqword(0x28u); if ( getifaddrs(\u0026ifap) == -1 ) { LODWORD(i) = 0; } else { for ( i = ifap; i; i = i-\u003eifa_next ) { ifa_addr = i-\u003eifa_addr; if ( ifa_addr \u0026\u0026 ifa_addr-\u003esa_family == 2 \u0026\u0026 !getnameinfo(ifa_addr, 0x10u, host, 0x401u, 0LL, 0, 1) \u0026\u0026 !strncmp(host, \"10.13.37.\", 9uLL) ) { LODWORD(i) = 1; break; } } This function fills ifap with a linked list of all network interfaces on the system.\nThe code iterates through every node in the linked list, extracts and processes interface addresses, uses getnameinfo() to resolve IP addresses into hostnames and then strncmp() to compare the first 9 characters of the host string to the target IP prefix(10.13.37.).\nWe can patch this in main().\nAddress Original Patch 24BB jz short loc_2477 jnz short loc_2477 sub_3378() This function checks running processes. It ensures that processes like Wireshark, Pspy, gdb, strace, or ltrace aren’t running. Additionally, it checks that apache2 is running, as it’s a must requirement to pass the check.\nv0 = 0; v10 = __readfsqword(0x28u); v1 = opendir(\"/proc\"); if ( v1 ) { v2 = v1; v0 = 1; while ( 1 ) { v3 = readdir(v2); if ( !v3 ) break; if ( v3-\u003ed_type == 4 ) { d_name = v3-\u003ed_name; if ( atoi(v3-\u003ed_name) \u003e 0 ) { snprintf(s, 0x100uLL, \"/proc/%s/cmdline\", d_name); v5 = fopen(s, \"r\"); v6 = v5; if ( v5 ) { if ( fgets(haystack, 1024, v5) ) { if ( strstr(haystack, \"wireshark\") || strstr(haystack, \"pspy\") || strstr(haystack, \"gdb\") || strstr(haystack, \"strace\") || strstr(haystack, \"ltrace\") ) { v0 = 1; fclose(v6); break; } v0 = (strstr(haystack, \"apache2\") == 0LL) \u0026 (unsigned __int8)v0; } We can patch this check in main().\nAddress Original Patch 24C6 jnz short loc_2477 jz short loc_2477 sub_3503() This function validates the username of the user and it can be patched in main()\nAddress Original Patch 24CF jz short loc_2477 jnz short loc_2477 sub_2C87() This function validates the environment variable LD_PRELOAD in the UNIX-like operating systems. LD_PRELOAD allows to specify shared libraries to be loaded before all others when a program is executed. By doing so, existing functions can be overridden or extended. We are not doing anything like that and thus this doesn’t need to be patched.\nsub_2C5A() This function performs another anti-VM check, looking at the fan count. Virtual machines typically report a fan count of zero, which would cause the check to fail.\nThis is done by reading /sys/devices, /sys/class/hwmon, /proc/acpi/fan - virtual filesystems that expose kernel and system information to user space.\nThe patch for this is applied in main(), where the instruction jle can be changed to jge.\nOpcode for JLE is 7E and JGE is 7D\nAddress Original Patch 24E3 jle short loc_2477 jge short loc_2477 sub_2793() This function checks the hostname of the machine, expecting it to be www.\nTo bypass this, we need to patch main().\nif ( v3 \u0026\u0026 (v5 = strcmp(v3, \"www\")) == 0 ) Address Original Patch 2508 jz short loc_2524 jnz short loc_2524 sub_2C9F() More checks but we are at the end.\nv4 = (char *)sub_2C9F(); char *sub_2C9F() { char *v0; // rbx char *v1; // rbp char *v2; // r12 char *v3; // r13 __int64 v4; // r15 char *v5; // rax char *v6; // r14 unsigned int v8; // [rsp+Ch] [rbp-3Ch] v0 = (char *)sub_2826(); v1 = (char *)sub_2793(); v2 = (char *)sub_27FB(); v3 = (char *)sub_298E(); v4 = (unsigned int)sub_2C5A(); v8 = sub_2C87(); v5 = (char *)malloc(0x2000uLL); v6 = v5; if ( v5 ) { if ( !v3 ) v3 = \"unknown\"; if ( !v2 ) v2 = \"unknown\"; if ( !v1 ) v1 = \"unknown\"; if ( !v0 ) v0 = \"unknown\"; snprintf( v5, 0x2000uLL, \"{\\\"ip_addresses\\\": \\\"%s\\\", \\\"hostname\\\": \\\"%s\\\", \\\"username\\\": \\\"%s\\\", \\\"processes\\\": \\\"%s\\\", \\\"fan_count\\\": %d, \\\"\" \"ld_preload_set\\\": %d}\", v0, v1, v2, v3, v4, v8); } else { perror(\"malloc\"); free(v0); free(v1); free(v2); free(v3); } return v6; } This time, there are four new functions, along with the previous `LD_PRELOAD and fan count checks. The four new functions peform a duplicate functionality of some of the previous validations.\nFunction Validation sub_2826 IP Address sub_2793 Hostname sub_27FB Username sub_298E Apache2 process Earlier, we identified the executable as PIE-enabled. This means the executable uses relative addressing for its functions and data instead of hardcoded absolute memory addresses.\nThe code references locations relative to the current instruction pointer (RIP). This allows the program to run correctly no matter where it’s loaded in memory.\nWhat does this have to do with the patching? Well, we will apply patches using relative addresses.\nInstead of patching the functions, we will patch the if-statements and the unknown strings that are assigned.\nLets start off with v3, which is supposed to return apache2.\nHow is the relative address calculated?\n(address of string)-(address of lea instruction + 7) 7 is the instruction size estimate for lea\nPressing SHIFT+F12 brings up the strings list. There we can find the apache2 string at location 0x41AF. lea instruction is located at 0x2D33\nOffset = 41AF - (2D33 + 7) = 1475 = 75 14 converted to Little-Endian Now that we have the correct offset, we can change the code.\nSelect the following instruction and patch the code(Edit-\u003ePatch Program-\u003eChange Bytes). Keep the first 3 bytes and add the offset.\nAddress Original Patch 2D33 4C 8D 2D 58 13 00 00 4C 8D 2D 75 14 00 00 We repeat the same process for v2(meatctf), v1(www) and v0(10.13.37.).\nThe calculated offsets are as follows:\nName Offset (Little-Endian) v2(meatctf) 71 14 v1(www) 6B 15 v0(10.13.37.) 26 14 Now that assigned values are patched we need to patch and reverse the if-statements too.\nAddress Original Patch 2D31 jnz short loc_2D3A jz short loc_2D3A 2D3D jnz short loc_2D46 jz short loc_2D46 2D49 jnz short loc_2D52 jz short loc_2D52 2D55 jnz short loc_2D5E jz short loc_2D5E sub_2C87() is the LD_PRELOAD. This one we can ignore again.\nsub_2C5A() is the fan check, but instead of patching the function itself, a patch can be applied to sprintf() in sub_2C9F(), which appears to store some kind of JSON data.\nAddress Instruction 2D6E lea rdx, aIpAddressesSHo Double-click on aIpAddressesSHo to go to the string, switch to Hex-View and replace the %d delimeter after fan_count with a number above 0, like 2. Apply the change.\nThat was all. Save the changes and run the program.\nBinary patch\nDownload carrot.diff\nApply the patch.\nbspatch carrot carrot_patched carrot.diff ","wordCount":"2895","inLanguage":"en","datePublished":"2025-02-28T00:00:00Z","dateModified":"2025-02-28T00:00:00Z","author":{"@type":"Person","name":"Yordan D."},"mainEntityOfPage":{"@type":"WebPage","@id":"https://hexed.space/posts/metactf-february-2025-flash-ctf/"},"publisher":{"@type":"Organization","name":"He\\xED.SPACE","logo":{"@type":"ImageObject","url":"https://hexed.space/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://hexed.space/ accesskey=h title="He\xED.SPACE (Alt + H)">He\xED.SPACE</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://hexed.space/posts title=Posts><span>Posts</span></a></li><li><a href=https://hexed.space/archives title=Archive><span>Archive</span></a></li><li><a href=https://hexed.space/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://hexed.space/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hexed.space/>Home</a>&nbsp;»&nbsp;<a href=https://hexed.space/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">MetaCTF February 2025 Flash CTF</h1><div class=post-description>MetaCTF February 2025 Flash CTF challenges from https://metactf.com</div><div class=post-meta><span title='2025-02-28 00:00:00 +0000 UTC'>February 28, 2025</span>&nbsp;·&nbsp;<span>Yordan D.</span></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#cookie-crackdown>Cookie Crackdown</a></li><li><a href=#better_eval>better_eval()</a></li><li><a href=#till-delete-do-us-part>Till Delete Do Us Part</a></li><li><a href=#carrot>Carrot</a><ul><li></li></ul></li></ul></nav></div></details></div><div class=post-content><p>MetaCTF February 2025 Flash CTF consists of 5 challenges.</p><h2 id=cookie-crackdown>Cookie Crackdown<a hidden class=anchor aria-hidden=true href=#cookie-crackdown>#</a></h2><blockquote><p>We&rsquo;re auditing some websites to check if they&rsquo;re GDPR compliant, and I&rsquo;m pretty sure this site isn&rsquo;t&mldr;</p></blockquote><p>Upon loading the site, we are presented with a modal requiring us to consent to cookies.</p><p>From the challenge description and the web page, we can assume that the flag is probably stored as a cookie.</p><p>Pressing <code>F12</code> will bring up the Developer menu. Navigating to the <code>Application</code> tab and then selecting <code>Cookies</code> will reveal a cookie conveniently named <code>flag</code>.</p><p><img alt="cookie crackdown flag" loading=lazy src=/posts/metactf-february-2025-flash-ctf/images/cookie_crackdown_flag.png></p><h2 id=better_eval>better_eval()<a hidden class=anchor aria-hidden=true href=#better_eval>#</a></h2><blockquote><p>I just want to let people run python code, but they keep trying to read flag.txt. So, I made a better eval that has filters to stop this!<br>Download the code here and connect to the remote instance with nc [REDACTED] 30019<br>In the event that remote instance goes down, you can also use nc [REDACTED] 5110. These two are identical, this is just the backup.</p></blockquote><p>Here&rsquo;s the Python code</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=ch>#!/usr/local/bin/python</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>better_eval</span><span class=p>(</span><span class=n>untrusted_code</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>blocked_terms</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;flag&#34;</span><span class=p>,</span> <span class=s2>&#34;+&#34;</span><span class=p>,</span> <span class=s2>&#34;import&#34;</span><span class=p>,</span> <span class=s2>&#34;os&#34;</span><span class=p>,</span> <span class=s2>&#34;eval&#34;</span><span class=p>,</span> <span class=s2>&#34;exec&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>term</span> <span class=ow>in</span> <span class=n>blocked_terms</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>term</span> <span class=ow>in</span> <span class=n>untrusted_code</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;The term </span><span class=si>{</span><span class=n>term</span><span class=si>}</span><span class=s2> is filtered!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># Execute the user input in the restricted environment without globals or locals</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=nb>eval</span><span class=p>(</span><span class=n>untrusted_code</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>untrusted_code</span> <span class=o>=</span> <span class=nb>input</span><span class=p>(</span><span class=s2>&#34;Enter your python code&gt; &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>better_eval</span><span class=p>(</span><span class=n>untrusted_code</span><span class=p>)</span>
</span></span></code></pre></div><p>We can see that there is a list of blocked keywords, including <code>import</code>, <code>os</code>, and <code>flag</code>.</p><p>Although this appears to impose strict limitations, we can bypass the filter with a simple one-liner using obfuscation:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Python data-lang=Python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=s2>&#34;txt.galf&#34;</span><span class=p>[::</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>read</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>())</span>
</span></span></code></pre></div><p>This command opens and prints the content of the <code>flag.txt</code> file. To evade the filter, we spell &ldquo;flag.txt&rdquo; backwards and then reverse it in Python to access the correct filename.</p><p>Exploiting the filter</p><pre tabindex=0><code>└─$ nc [REDACTED] 30019
Enter your python code&gt; print(open(&#34;txt.galf&#34;[::-1]).read().strip())
MetaCTF{f1l73rs_d0_n0t_s3cur3_u}
None
Enter your python code&gt; 
</code></pre><p>By reversing the string <code>flag.txt</code>, we successfully bypassed the keyword filter and retrieved the flag. This demonstrates that simple blacklisting of keywords is not a reliable security measure, as it can often be circumvented with obfuscation techniques.</p><h2 id=till-delete-do-us-part>Till Delete Do Us Part<a hidden class=anchor aria-hidden=true href=#till-delete-do-us-part>#</a></h2><blockquote><p>I was messing with trying to dual boot, and while trying to fix partitions, I accidentally deleted the one on my wedding flash drive I carelessly had plugged in! Please help me recover it!</p></blockquote><p>Once we download the file, we need to identify its type with <code>file</code> command:</p><pre tabindex=0><code>└─$ file usb.img    
usb.img: DOS/MBR boot sector
</code></pre><p>This indicates that the file is a disk image containing a DOS/MBR boot sector. It could represent a USB drive, hard drive, or partition.</p><p>We use <code>fdisk</code> or <code>parted</code> to inspect the partitions:</p><pre tabindex=0><code>└─$ fdisk -l usb.img
Disk usb.img: 256 MiB, 268435456 bytes, 524288 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xf4fa0c7e
</code></pre><pre tabindex=0><code>└─$ parted usb.img     
WARNING: You are not superuser.  Watch out for permissions.
GNU Parted 3.6
Using /home/kali/metactf_ctf 2025 feb/usbnew/usb.img
Welcome to GNU Parted! Type &#39;help&#39; to view a list of commands.
(parted) print                                                            
Model:  (file)
Disk /home/kali/metactf_ctf 2025 feb/usbnew/usb.img: 268MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 

Number  Start  End  Size  Type  File system  Flags
</code></pre><p>No partitions are found. Since they might have been deleted, we attempt to recover them.</p><p>We use <code>testdisk</code> to restore the lost partition:</p><pre tabindex=0><code>testdisk usb.img
</code></pre><ol><li>Select Proceed</li><li>Choose Intel for the partition table</li><li>Select Analyse -> Quick Search</li><li>Locate the FAT32 partition and select Write</li><li>Confirm with <code>Y</code> and press Enter</li></ol><p>If we check again with <code>fdisk</code> or <code>parted</code>, the partitions should be restored:</p><pre tabindex=0><code>└─$ fdisk -l usb.img     
Disk usb.img: 256 MiB, 268435456 bytes, 524288 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xf4fa0c7e

Device     Boot Start    End Sectors  Size Id Type
usb.img1   *     2048 524287  522240  255M  b W95 FAT32
</code></pre><pre tabindex=0><code>─$ parted usb.img       
(parted) print                                                            
Model:  (file)
Disk /home/kali/metactf_ctf 2025 feb/usbnew/usb.img: 268MB
Sector size (logical/physical): 512B/512B
Partition Table: msdos
Disk Flags: 

Number  Start   End    Size   Type     File system  Flags
 1      1049kB  268MB  267MB  primary  fat32        boot
</code></pre><p>Next, we will need to mount the drive.
To mount a disk image containing partitions, we must specify the offset so the system knows where the partition starts.
The offset is calculated as:</p><pre tabindex=0><code>Offset = Starting Sector × Sector Size
Offset = 2048 × 512 = 1048576
</code></pre><p>For most disks the sector size is 512.</p><p>We can mount the partition:</p><pre tabindex=0><code>sudo mount -o loop,offset=1048576 usb.img /mnt/usb
</code></pre><p>Once mounted, we can explore the drive. Let&rsquo;s check the Wedding photos directory for any hidden messages:</p><pre tabindex=0><code>strings *.jpg | grep -i Meta
</code></pre><p>Nothing comes up.</p><p>We can use also <code>SleuthKit</code> and <code>fls</code> to list all files, including deleted ones:</p><pre tabindex=0><code>fls -r -o 2048 usb.img
</code></pre><p>Nowe we have a list of all the files and directories, including the ones marked as deleted.</p><pre tabindex=0><code>d/d 62691:      .Meta
+ d/d 62677:    CTF
++ d/d 62710:   {n
+++ d/d 62725:  0
++++ d/d 62742: t
+++++ d/d 62757:        _
++++++ d/d 62774:       ev
+++++++ d/d 62790:      3n
++++++++ d/d 62805:     _
+++++++++ d/d 62822:    d3
++++++++++ d/d 62838:   l3t
+++++++++++ d/d 62854:  10n
++++++++++++ d/d 62869: _
+++++++++++++ d/d 62886:        c4
++++++++++++++ d/d 62902:       n
+++++++++++++++ d/d 62917:      _
++++++++++++++++ d/d 62934:     s3
+++++++++++++++++ d/d 62950:    part
++++++++++++++++++ d/d 62965:   3_
+++++++++++++++++++ d/d 62982:  u
++++++++++++++++++++ d/d 62997: 5}
</code></pre><p>The flag is made of nested directories. Extract the directories&rsquo; names to reconstruct it.</p><p>Files marked for deletion can be recovered with <code>icat</code> and the sector offset:</p><pre tabindex=0><code>icat -o 2048 usb.img 63014 &gt; clue.txt
</code></pre><p>This extracts <code>clue.txt</code> from sector 63014.</p><h2 id=carrot>Carrot<a hidden class=anchor aria-hidden=true href=#carrot>#</a></h2><blockquote><p>Our threat intelligence has found a malware sample that seems heavily targeted at our competitor, MeatCTF. We tried to analyze it, but it just does nothing when we run it in a VM, can you help us analyze this?<br>Download the sample here and unzip with the password infected</p></blockquote><p>Extract the file and run <code>file</code>:</p><pre tabindex=0><code>└─$ file carrot           
carrot: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=fd82f7845645aea67dee789f5cac0de456e83108, for GNU/Linux 4.4.0, stripped
</code></pre><p>This is a 64-bit Linux ELF binary, dynamically linked and PIE-enabled, keep that in mind for later.</p><p>Load it into IDA for static analysis. Press F5 to generate pseudocode.</p><p>Scrolling through the functions, we find <code>.PEM_read_bio_RSA_PUBKEY</code>, indicating that encryption is likely occurring somewhere in the code.</p><p>Open the <code>main</code> function and its pseudocode.</p><p>We can see there&rsquo;s a block of <code>if</code> statements that lead to more code execution. To reach that point in the code, we will need to pass the validation checks presented by the aforementioned <code>if</code> block.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_3531</span><span class=p>(</span><span class=n>a1</span><span class=p>,</span> <span class=n>a2</span><span class=p>,</span> <span class=n>a3</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_371A</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_3773</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_356F</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_3622</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_37DA</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_32B6</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_3378</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_3503</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_2C87</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=nf>sub_2C5A</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span></code></pre></div><p>There are quite a few, so let&rsquo;s go through them.</p><h4 id=sub_3531>sub_3531()<a hidden class=anchor aria-hidden=true href=#sub_3531>#</a></h4><p>This function appears to check if ptrace is running. Since we do not use ptrace, we can ignore this one.</p><h4 id=sub_371a>sub_371A()<a hidden class=anchor aria-hidden=true href=#sub_371a>#</a></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>_BOOL8</span> <span class=nf>sub_371A</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>time_t</span> <span class=n>v0</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_BOOL8</span> <span class=n>result</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>time_t</span> <span class=n>v2</span><span class=p>;</span> <span class=c1>// rbx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>time_t</span> <span class=n>v3</span><span class=p>;</span> <span class=c1>// rdi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>double</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// xmm0_8
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v0</span> <span class=o>=</span> <span class=nf>time</span><span class=p>(</span><span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v0</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=n>v0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>sleep</span><span class=p>(</span><span class=mh>0x96u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v3</span> <span class=o>=</span> <span class=nf>time</span><span class=p>(</span><span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v4</span> <span class=o>=</span> <span class=nf>difftime</span><span class=p>(</span><span class=n>v3</span><span class=p>,</span> <span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v4</span> <span class=o>&gt;=</span> <span class=mf>149.95</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>v4</span> <span class=o>&gt;</span> <span class=mf>150.25</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This is an anti-debugging function. It gets the system time, sleeps for 150 seconds, then gets the system time again after sleep. If the difference between the two times is about 150 seconds, it returns true, allowing the check to pass. If the difference is not close to 150 seconds, it returns false, and the check fails.<br>There are numerous ways to bypass this, but the easiest approach is to change the value of the sleep timer to 1 second (0x1 in hex).</p><p>Right click on the instruction, select Manual, and change 96h to 1h</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>372C</td><td>mov edi, 96h</td><td>mov edi, 1h</td></tr></tbody></table><p>Next, go to the main function, select the following instruction, then go to Edit -> Patch Program -> Change Byte:</p><table><thead><tr><th>Address</th><th>Instruction</th></tr></thead><tbody><tr><td>248C</td><td>jnz short loc_2477</td></tr></tbody></table><p>Replace the opcode for <code>jnz</code> (75) with <code>jz</code> (74) to reverse the if-statement:</p><pre tabindex=0><code>74 E9 E8 E0 12 00 00 85 C0 75 E0 E8 D3 10 00 00
</code></pre><table><thead><tr><th>Address</th><th>Original</th><th>Patched</th></tr></thead><tbody><tr><td>248C</td><td>jnz short loc_2477</td><td>jz short loc_2477</td></tr></tbody></table><h4 id=sub_3773>sub_3773()<a hidden class=anchor aria-hidden=true href=#sub_3773>#</a></h4><p>Another function that involves timers.<br>The loop continues until the difference (difftime(v2, v0)) is at least 150.0 seconds.<br>Once the loop exits, it calculates the final difference (v3 = difftime(v2, v0)) and sets result to 1 (TRUE).<br>At the end, it checks if v3 is greater than or equal to 149.95. If so, it returns whether v3 is greater than 150.25.</p><table><thead><tr><th>0 (false)</th><th>1 (true)</th></tr></thead><tbody><tr><td>If time(0LL) fails (returns -1).</td><td>If v3 >= 149.95 and v3 > 150.25.</td></tr><tr><td>If v3 >= 149.95 but v3 &lt;= 150.25.</td><td>If v3 &lt; 149.95.</td></tr></tbody></table><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>      <span class=n>v2</span> <span class=o>=</span> <span class=nf>time</span><span class=p>(</span><span class=mi>0LL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span> <span class=nf>difftime</span><span class=p>(</span><span class=n>v2</span><span class=p>,</span> <span class=n>v0</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mf>150.0</span> <span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>v3</span> <span class=o>=</span> <span class=nf>difftime</span><span class=p>(</span><span class=n>v2</span><span class=p>,</span> <span class=n>v0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>1LL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>&gt;=</span> <span class=mf>149.95</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>v3</span> <span class=o>&gt;</span> <span class=mf>150.25</span><span class=p>;</span>
</span></span></code></pre></div><p>The validation check only passes if the function returns FALSE. Let&rsquo;s patch it and reverse the process.</p><p>The opcode for <code>ja</code> is 77.<br>The opcode for <code>jb</code> is 72.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>37A9</td><td>ja short loc_3788</td><td>jb short loc_3788</td></tr></tbody></table><br><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>37C7</td><td>ja short loc_37D6</td><td>jb short loc_37D6</td></tr></tbody></table><p>Go back to <code>main()</code>.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>2495</td><td>jnz short loc_2477</td><td>jz short loc_2477</td></tr></tbody></table><h4 id=sub_356f>sub_356F()<a hidden class=anchor aria-hidden=true href=#sub_356f>#</a></h4><p>This checks ensures the code is not running in a VM. Specifically, it opens /proc/cpuinfo and checks whether or not &ldquo;hypervisor&rdquo; is present.<br>Reverse it by patching <code>jnz</code> to <code>jz</code> in <code>main()</code>. Opcodes were provided earlier in the write-up.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>249E</td><td>jnz short loc_35BB</td><td>jz short loc_35BB</td></tr></tbody></table><h4 id=sub_3622>sub_3622()<a hidden class=anchor aria-hidden=true href=#sub_3622>#</a></h4><p>Another anti-VM check. This one looks for the strings <code>QEMU</code>, <code>VirtualBox</code>, and <code>VMware</code>.
Just patch it in <code>main()</code>.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>24A7</td><td>jnz short loc_2477</td><td>jz short loc_2477</td></tr></tbody></table><h4 id=sub_37da>sub_37DA()<a hidden class=anchor aria-hidden=true href=#sub_37da>#</a></h4><p>This function uses <code>curl</code> to open two addresses: <code>https://metactf.com</code> and <code>https://e205e724dda896b5a70bb03b7aed1dba.metactf.com</code>.
If the first address returns HTTP status code 200, v0 is set to TRUE.
After this, curl tries to open the second address, and if the HTTP code is NOT 200, v0 is set to TRUE, and the function returns v0.
For this validation to pass, the first URL needs to be accessible, and the second URL must not be.
If we do a DNS check, we will find out that the second (sub)domain has no DNS records, so we don&rsquo;t need to do anything here.</p><h4 id=sub_32b6>sub_32B6()<a hidden class=anchor aria-hidden=true href=#sub_32b6>#</a></h4><p>This function validates the IP address of the machine. It checks if the machine’s IP address starts with <code>10.13.37.</code>. To bypass this, we will patch it in <code>main()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kr>__int64</span> <span class=nf>sub_32B6</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>ifaddrs</span> <span class=o>*</span><span class=n>i</span><span class=p>;</span> <span class=c1>// rbx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=k>struct</span> <span class=n>sockaddr</span> <span class=o>*</span><span class=n>ifa_addr</span><span class=p>;</span> <span class=c1>// rdi
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>ifaddrs</span> <span class=o>*</span><span class=n>ifap</span><span class=p>;</span> <span class=c1>// [rsp+8h] [rbp-430h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=n>host</span><span class=p>[</span><span class=mi>1025</span><span class=p>];</span> <span class=c1>// [rsp+17h] [rbp-421h] BYREF
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kr>__int64</span> <span class=n>v5</span><span class=p>;</span> <span class=c1>// [rsp+418h] [rbp-20h]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=nf>getifaddrs</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ifap</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>LODWORD</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span> <span class=n>i</span> <span class=o>=</span> <span class=n>ifap</span><span class=p>;</span> <span class=n>i</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>ifa_next</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ifa_addr</span> <span class=o>=</span> <span class=n>i</span><span class=o>-&gt;</span><span class=n>ifa_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>ifa_addr</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=n>ifa_addr</span><span class=o>-&gt;</span><span class=n>sa_family</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>getnameinfo</span><span class=p>(</span><span class=n>ifa_addr</span><span class=p>,</span> <span class=mh>0x10u</span><span class=p>,</span> <span class=n>host</span><span class=p>,</span> <span class=mh>0x401u</span><span class=p>,</span> <span class=mi>0LL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=nf>strncmp</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=s>&#34;10.13.37.&#34;</span><span class=p>,</span> <span class=mi>9uLL</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>LODWORD</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span></code></pre></div><p>This function fills <code>ifap</code> with a linked list of all network interfaces on the system.<br>The code iterates through every node in the linked list, extracts and processes interface addresses, uses getnameinfo() to resolve IP addresses into hostnames and then <code>strncmp()</code> to compare the first 9 characters of the <code>host</code> string to the target IP prefix(<code>10.13.37.</code>).<br>We can patch this in <code>main()</code>.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>24BB</td><td>jz short loc_2477</td><td>jnz short loc_2477</td></tr></tbody></table><h4 id=sub_3378>sub_3378()<a hidden class=anchor aria-hidden=true href=#sub_3378>#</a></h4><p>This function checks running processes. It ensures that processes like <code>Wireshark</code>, <code>Pspy</code>, <code>gdb</code>, <code>strace</code>, or <code>ltrace</code> aren&rsquo;t running. Additionally, it checks that <code>apache2</code> is running, as it&rsquo;s a must requirement to pass the check.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl>  <span class=n>v0</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>v10</span> <span class=o>=</span> <span class=nf>__readfsqword</span><span class=p>(</span><span class=mh>0x28u</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v1</span> <span class=o>=</span> <span class=nf>opendir</span><span class=p>(</span><span class=s>&#34;/proc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>v2</span> <span class=o>=</span> <span class=n>v1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>v0</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span> <span class=mi>1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>v3</span> <span class=o>=</span> <span class=nf>readdir</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v3</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span> <span class=n>v3</span><span class=o>-&gt;</span><span class=n>d_type</span> <span class=o>==</span> <span class=mi>4</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>d_name</span> <span class=o>=</span> <span class=n>v3</span><span class=o>-&gt;</span><span class=n>d_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span> <span class=nf>atoi</span><span class=p>(</span><span class=n>v3</span><span class=o>-&gt;</span><span class=n>d_name</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>snprintf</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=mh>0x100uLL</span><span class=p>,</span> <span class=s>&#34;/proc/%s/cmdline&#34;</span><span class=p>,</span> <span class=n>d_name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>v5</span> <span class=o>=</span> <span class=nf>fopen</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=s>&#34;r&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>v6</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span> <span class=n>v5</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span> <span class=nf>fgets</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=mi>1024</span><span class=p>,</span> <span class=n>v5</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=s>&#34;wireshark&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=o>||</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=s>&#34;pspy&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=o>||</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=s>&#34;gdb&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=o>||</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=s>&#34;strace&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=o>||</span> <span class=nf>strstr</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=s>&#34;ltrace&#34;</span><span class=p>)</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>v0</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=nf>fclose</span><span class=p>(</span><span class=n>v6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>              <span class=n>v0</span> <span class=o>=</span> <span class=p>(</span><span class=nf>strstr</span><span class=p>(</span><span class=n>haystack</span><span class=p>,</span> <span class=s>&#34;apache2&#34;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0LL</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kr>__int8</span><span class=p>)</span><span class=n>v0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span></code></pre></div><p>We can patch this check in <code>main()</code>.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>24C6</td><td>jnz short loc_2477</td><td>jz short loc_2477</td></tr></tbody></table><h4 id=sub_3503>sub_3503()<a hidden class=anchor aria-hidden=true href=#sub_3503>#</a></h4><p>This function validates the username of the user and it can be patched in <code>main()</code></p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>24CF</td><td>jz short loc_2477</td><td>jnz short loc_2477</td></tr></tbody></table><h4 id=sub_2c87>sub_2C87()<a hidden class=anchor aria-hidden=true href=#sub_2c87>#</a></h4><p>This function validates the environment variable <code>LD_PRELOAD</code> in the UNIX-like operating systems.
<code>LD_PRELOAD</code> allows to specify shared libraries to be loaded before all others when a program is executed. By doing so, existing functions can be overridden or extended.
We are not doing anything like that and thus this doesn&rsquo;t need to be patched.</p><h4 id=sub_2c5a>sub_2C5A()<a hidden class=anchor aria-hidden=true href=#sub_2c5a>#</a></h4><p>This function performs another anti-VM check, looking at the fan count. Virtual machines typically report a fan count of zero, which would cause the check to fail.<br>This is done by reading <code>/sys/devices</code>, <code>/sys/class/hwmon</code>, <code>/proc/acpi/fan</code> - virtual filesystems that expose kernel and system information to user space.<br>The patch for this is applied in <code>main()</code>, where the instruction <code>jle</code> can be changed to <code>jge</code>.</p><p>Opcode for <code>JLE</code> is <code>7E</code> and <code>JGE</code> is <code>7D</code></p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>24E3</td><td>jle short loc_2477</td><td>jge short loc_2477</td></tr></tbody></table><h4 id=sub_2793>sub_2793()<a hidden class=anchor aria-hidden=true href=#sub_2793>#</a></h4><p>This function checks the hostname of the machine, expecting it to be <code>www</code>.<br>To bypass this, we need to patch <code>main()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span> <span class=n>v3</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>v5</span> <span class=o>=</span> <span class=nf>strcmp</span><span class=p>(</span><span class=n>v3</span><span class=p>,</span> <span class=s>&#34;www&#34;</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>)</span>
</span></span></code></pre></div><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>2508</td><td>jz short loc_2524</td><td>jnz short loc_2524</td></tr></tbody></table><h4 id=sub_2c9f>sub_2C9F()<a hidden class=anchor aria-hidden=true href=#sub_2c9f>#</a></h4><p>More checks but we are at the end.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>v4</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>sub_2C9F</span><span class=p>();</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=kt>char</span> <span class=o>*</span><span class=nf>sub_2C9F</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>v0</span><span class=p>;</span> <span class=c1>// rbx
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v1</span><span class=p>;</span> <span class=c1>// rbp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v2</span><span class=p>;</span> <span class=c1>// r12
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v3</span><span class=p>;</span> <span class=c1>// r13
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kr>__int64</span> <span class=n>v4</span><span class=p>;</span> <span class=c1>// r15
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v5</span><span class=p>;</span> <span class=c1>// rax
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>v6</span><span class=p>;</span> <span class=c1>// r14
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>v8</span><span class=p>;</span> <span class=c1>// [rsp+Ch] [rbp-3Ch]
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>v0</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>sub_2826</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v1</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>sub_2793</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v2</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>sub_27FB</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v3</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>sub_298E</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v4</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>int</span><span class=p>)</span><span class=nf>sub_2C5A</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v8</span> <span class=o>=</span> <span class=nf>sub_2C87</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=n>v5</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>malloc</span><span class=p>(</span><span class=mh>0x2000uLL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>v6</span> <span class=o>=</span> <span class=n>v5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span> <span class=n>v5</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v3</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>v3</span> <span class=o>=</span> <span class=s>&#34;unknown&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v2</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>v2</span> <span class=o>=</span> <span class=s>&#34;unknown&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v1</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>v1</span> <span class=o>=</span> <span class=s>&#34;unknown&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span> <span class=o>!</span><span class=n>v0</span> <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>v0</span> <span class=o>=</span> <span class=s>&#34;unknown&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>snprintf</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>v5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=mh>0x2000uLL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;{</span><span class=se>\&#34;</span><span class=s>ip_addresses</span><span class=se>\&#34;</span><span class=s>: </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>, </span><span class=se>\&#34;</span><span class=s>hostname</span><span class=se>\&#34;</span><span class=s>: </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>, </span><span class=se>\&#34;</span><span class=s>username</span><span class=se>\&#34;</span><span class=s>: </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>, </span><span class=se>\&#34;</span><span class=s>processes</span><span class=se>\&#34;</span><span class=s>: </span><span class=se>\&#34;</span><span class=s>%s</span><span class=se>\&#34;</span><span class=s>, </span><span class=se>\&#34;</span><span class=s>fan_count</span><span class=se>\&#34;</span><span class=s>: %d, </span><span class=se>\&#34;</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>      <span class=s>&#34;ld_preload_set</span><span class=se>\&#34;</span><span class=s>: %d}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>v0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>v1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>v2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>v3</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>v4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>v8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>perror</span><span class=p>(</span><span class=s>&#34;malloc&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>v0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>v1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>v2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>v3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>v6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This time, there are four new functions, along with the previous `LD_PRELOAD and fan count checks.
The four new functions peform a duplicate functionality of some of the previous validations.</p><table><thead><tr><th>Function</th><th>Validation</th></tr></thead><tbody><tr><td>sub_2826</td><td>IP Address</td></tr><tr><td>sub_2793</td><td>Hostname</td></tr><tr><td>sub_27FB</td><td>Username</td></tr><tr><td>sub_298E</td><td>Apache2 process</td></tr></tbody></table><p>Earlier, we identified the executable as PIE-enabled. This means the executable uses relative addressing for its functions and data instead of hardcoded absolute memory addresses.<br>The code references locations relative to the current instruction pointer (RIP). This allows the program to run correctly no matter where it&rsquo;s loaded in memory.</p><p>What does this have to do with the patching? Well, we will apply patches using relative addresses.<br>Instead of patching the functions, we will patch the if-statements and the <code>unknown</code> strings that are assigned.</p><p>Lets start off with <code>v3</code>, which is supposed to return <code>apache2</code>.<br>How is the relative address calculated?</p><pre tabindex=0><code>(address of string)-(address of lea instruction + 7)     
</code></pre><p><code>7</code> is the instruction size estimate for <code>lea</code></p><p>Pressing <code>SHIFT+F12</code> brings up the strings list. There we can find the <code>apache2</code> string at location <code>0x41AF</code>. <code>lea</code> instruction is located at <code>0x2D33</code></p><pre tabindex=0><code>Offset = 41AF - (2D33 + 7) = 1475
= 75 14 converted to  Little-Endian
</code></pre><p>Now that we have the correct offset, we can change the code.<br>Select the following instruction and patch the code(Edit->Patch Program->Change Bytes). Keep the first 3 bytes and add the offset.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>2D33</td><td>4C 8D 2D 58 13 00 00</td><td>4C 8D 2D 75 14 00 00</td></tr></tbody></table><p>We repeat the same process for <code>v2(meatctf)</code>, <code>v1(www)</code> and <code>v0(10.13.37.)</code>.<br>The calculated offsets are as follows:</p><table><thead><tr><th>Name</th><th>Offset (Little-Endian)</th></tr></thead><tbody><tr><td>v2(meatctf)</td><td>71 14</td></tr><tr><td>v1(www)</td><td>6B 15</td></tr><tr><td>v0(10.13.37.)</td><td>26 14</td></tr></tbody></table><p>Now that assigned values are patched we need to patch and reverse the if-statements too.</p><table><thead><tr><th>Address</th><th>Original</th><th>Patch</th></tr></thead><tbody><tr><td>2D31</td><td>jnz short loc_2D3A</td><td>jz short loc_2D3A</td></tr><tr><td>2D3D</td><td>jnz short loc_2D46</td><td>jz short loc_2D46</td></tr><tr><td>2D49</td><td>jnz short loc_2D52</td><td>jz short loc_2D52</td></tr><tr><td>2D55</td><td>jnz short loc_2D5E</td><td>jz short loc_2D5E</td></tr></tbody></table><p><code>sub_2C87()</code> is the <code>LD_PRELOAD</code>. This one we can ignore again.</p><p><code>sub_2C5A()</code> is the fan check, but instead of patching the function itself, a patch can be applied to <code>sprintf()</code> in <code>sub_2C9F()</code>, which appears to store some kind of JSON data.</p><table><thead><tr><th>Address</th><th>Instruction</th></tr></thead><tbody><tr><td>2D6E</td><td>lea rdx, aIpAddressesSHo</td></tr></tbody></table><p>Double-click on <code>aIpAddressesSHo</code> to go to the string, switch to Hex-View and replace the <code>%d</code> delimeter after <code>fan_count</code> with a number above 0, like 2. Apply the change.</p><p>That was all. Save the changes and run the program.</p><p><img alt="carrot flag" loading=lazy src=/posts/metactf-february-2025-flash-ctf/images/carrot_flag.png></p><p>Binary patch<br>Download <a href=/posts/metactf-february-2025-flash-ctf/carrot.diff>carrot.diff</a></p><p>Apply the patch.</p><pre tabindex=0><code>bspatch carrot carrot_patched carrot.diff
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://hexed.space/tags/ctf/>Ctf</a></li></ul><nav class=paginav><a class=prev href=https://hexed.space/posts/metactf-july-2025-flash-ctf/><span class=title>« Prev</span><br><span>MetaCTF July 2025 Flash CTF - NOThing to C Here</span>
</a><a class=next href=https://hexed.space/posts/metactf-november-2024-flash-ctf/><span class=title>Next »</span><br><span>MetaCTF November 2024 Flash CTF</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on x" href="https://x.com/intent/tweet/?text=MetaCTF%20February%202025%20Flash%20CTF&amp;url=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f&amp;hashtags=ctf"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f&amp;title=MetaCTF%20February%202025%20Flash%20CTF&amp;summary=MetaCTF%20February%202025%20Flash%20CTF&amp;source=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f&title=MetaCTF%20February%202025%20Flash%20CTF"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on whatsapp" href="https://api.whatsapp.com/send?text=MetaCTF%20February%202025%20Flash%20CTF%20-%20https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on telegram" href="https://telegram.me/share/url?text=MetaCTF%20February%202025%20Flash%20CTF&amp;url=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share MetaCTF February 2025 Flash CTF on ycombinator" href="https://news.ycombinator.com/submitlink?t=MetaCTF%20February%202025%20Flash%20CTF&u=https%3a%2f%2fhexed.space%2fposts%2fmetactf-february-2025-flash-ctf%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://hexed.space/>He\xED.SPACE</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");if(menu){const e=localStorage.getItem("menu-scroll-position");e&&(menu.scrollLeft=parseInt(e,10)),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}}document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{const e=document.querySelector("html");e.dataset.theme==="dark"?(e.dataset.theme="light",localStorage.setItem("pref-theme","light")):(e.dataset.theme="dark",localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>